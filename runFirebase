#!/bin/bash

# runFirebase - Script para instalar NVM, Node.js y ejecutar Angular
# Autor: Alice Wiki Project
# Uso: ./runFirebase

set -e  # Detener el script si hay alg√∫n error

unset NPM_CONFIG_PREFIX 

echo "=========================================="
echo "   üöÄ Iniciando runFirebase Script"
echo "=========================================="
echo ""

# Colores para output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Funci√≥n para mostrar mensajes
print_step() {
    echo -e "${BLUE}‚ñ∂ $1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úì $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö† $1${NC}"
}

print_error() {
    echo -e "${RED}‚úó $1${NC}"
}

# Paso 1: Instalar NVM
print_step "Paso 1: Instalando NVM (Node Version Manager)..."
if [ -d "$HOME/.nvm" ]; then
    print_warning "NVM ya est√° instalado. Saltando instalaci√≥n..."
else
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
    print_success "NVM instalado correctamente"
fi
echo ""

# Paso 2: Cargar NVM
print_step "Paso 2: Cargando NVM en la sesi√≥n actual..."
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
print_success "NVM cargado correctamente"
echo ""

# Paso 3: Instalar Node.js 25
print_step "Paso 3: Instalando Node.js v25..."
nvm install 25
print_success "Node.js v25 instalado"
echo ""

# Paso 4: Limpiar variable NPM_CONFIG_PREFIX
print_step "Paso 4: Limpiando variable NPM_CONFIG_PREFIX..."
unset NPM_CONFIG_PREFIX
print_success "Variable limpiada"
echo ""

# Paso 5: Usar Node.js 25
print_step "Paso 5: Activando Node.js v25..."
nvm use 25
print_success "Node.js v25 activado"
echo ""

# Mostrar versiones instaladas
print_step "Versiones instaladas:"
echo "  Node: $(node --version)"
echo "  NPM: $(npm --version)"
echo ""

# Verificar si Angular CLI est√° instalado
print_step "Verificando Angular CLI..."
if ! command -v ng &> /dev/null; then
    print_warning "Angular CLI no encontrado. Instalando globalmente..."
    npm install -g @angular/cli
    print_success "Angular CLI instalado"
else
    print_success "Angular CLI ya est√° instalado ($(ng version --minimal))"
fi
echo ""

# Verificar si estamos en un proyecto Angular
if [ ! -f "angular.json" ]; then
    print_error "No se encontr√≥ angular.json en el directorio actual"
    print_warning "Aseg√∫rate de estar en la ra√≠z de tu proyecto Angular"
    exit 1
fi

# Verificar si node_modules existe
if [ ! -d "node_modules" ]; then
    print_step "Instalando dependencias del proyecto..."
    npm install
    print_success "Dependencias instaladas"
    echo ""
fi

# Paso 6: Ejecutar servidor de desarrollo
print_step "Paso 6: Iniciando servidor de desarrollo Angular..."
echo ""
echo "=========================================="
echo "   üåü Servidor iniciado"
echo "=========================================="
echo "  üì° Local:   http://localhost:9002"
echo "  üåê Network: http://0.0.0.0:9002"
echo ""
echo "  Presiona Ctrl+C para detener el servidor"
echo "=========================================="
echo ""

ng serve --port 9002 --host 0.0.0.0
